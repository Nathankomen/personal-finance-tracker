document.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("copy",t=>t.preventDefault()),document.addEventListener("cut",t=>t.preventDefault()),document.addEventListener("selectstart",t=>t.preventDefault()),document.addEventListener("dragstart",t=>t.preventDefault());let token=null,userId=null,chartType="doughnut",chart,authDiv=document.getElementById("auth"),appDiv=document.getElementById("app"),nameInput=document.getElementById("name"),emailInput=document.getElementById("email"),passwordInput=document.getElementById("password"),registerBtn=document.getElementById("registerBtn"),loginBtn=document.getElementById("loginBtn"),logoutBtn=document.getElementById("logoutBtn"),descriptionInput=document.getElementById("description"),amountInput=document.getElementById("amount"),typeSelect=document.getElementById("type"),categoryInput=document.getElementById("category"),transactionForm=document.getElementById("transaction-form"),transactionsList=document.getElementById("transactions-list"),balanceEl=document.getElementById("balance"),incomeEl=document.getElementById("income"),expensesEl=document.getElementById("expenses"),summaryOutput=document.getElementById("summary-output"),periodSelect=document.getElementById("period-select"),loadSummaryBtn=document.getElementById("load-summary-btn"),toggleChartBtn=document.getElementById("toggleChartBtn"),exportChartBtn=document.getElementById("exportChartBtn"),downloadPdfBtn=document.getElementById("downloadPdfBtn"),profileName=document.getElementById("profile-name"),profilePicture=document.getElementById("profile-picture");function updateChart(t,e){var a=document.getElementById("spendingChart").getContext("2d");chart&&chart.destroy(),chart=new Chart(a,{type:chartType,data:{labels:["Income","Expenses"],datasets:[{data:[t,e],backgroundColor:["#4CAF50","#f44336"]}]},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:"Finance Overview"}}}})}async function loadTransactions(){if(token)try{var t=await(await fetch("http://localhost:3000/api/transactions",{headers:{Authorization:token}})).json();transactionsList.innerHTML="";let a=0,n=0;t.forEach(t=>{var e=document.createElement("li");e.textContent=`${t.description} - $${parseFloat(t.amount).toFixed(2)} [${t.category}]`,e.classList.add(t.type),e.onclick=()=>deleteTransaction(t.id),transactionsList.appendChild(e),"income"===t.type?a+=parseFloat(t.amount):n+=parseFloat(t.amount)}),balanceEl.textContent=(a-n).toFixed(2),incomeEl.textContent=a.toFixed(2),expensesEl.textContent=n.toFixed(2),updateChart(a,n)}catch(t){console.error("Failed to load transactions:",t)}}async function deleteTransaction(t){await fetch("http://localhost:3000/api/transactions/"+t,{method:"DELETE",headers:{Authorization:token}}),loadTransactions()}toggleChartBtn.addEventListener("click",()=>{chartType="doughnut"===chartType?"bar":"doughnut",loadTransactions()}),exportChartBtn.addEventListener("click",()=>{var t,e;chart&&(t=chart.toBase64Image(),(e=document.createElement("a")).href=t,e.download="finance_chart.png",e.click())}),transactionForm.addEventListener("submit",async t=>{t.preventDefault();t={description:descriptionInput.value,amount:parseFloat(amountInput.value),type:typeSelect.value,category:categoryInput.value||"General"};await fetch("http://localhost:3000/api/transactions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:token},body:JSON.stringify(t)}),descriptionInput.value="",amountInput.value="",categoryInput.value="",loadTransactions()}),registerBtn.addEventListener("click",async()=>{var t=document.getElementById("profile-upload-auth").files[0],e=new FormData;e.append("name",nameInput.value),e.append("email",emailInput.value),e.append("password",passwordInput.value),t&&e.append("profile_picture",t);t=await(await fetch("http://localhost:3000/api/auth/register",{method:"POST",body:e})).json();alert(t.success?"Registered! Please login.":t.error)}),loginBtn.addEventListener("click",async()=>{var t=await(await fetch("http://localhost:3000/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:emailInput.value,password:passwordInput.value})})).json();t.success?(token=t.token,userId=t.userId,localStorage.setItem("token",token),localStorage.setItem("userId",userId),authDiv.style.display="none",appDiv.style.display="block",profileName.textContent=t.name,profilePicture.src=t.profile_picture?"http://localhost:3000/uploads/"+t.profile_picture:"default-avatar.png",loadTransactions()):alert(t.error)}),window.addEventListener("load",async()=>{var t=localStorage.getItem("token"),e=localStorage.getItem("userId");if(t&&e){token=t,userId=e,authDiv.style.display="none",appDiv.style.display="block",await loadTransactions();try{var a=await(await fetch("http://localhost:3000/api/auth/profile/"+userId,{headers:{Authorization:token}})).json();profileName.textContent=a.name,profilePicture.src=a.profile_picture?"http://localhost:3000/uploads/"+a.profile_picture:"default-avatar.png"}catch(t){console.error("Failed to fetch profile on refresh:",t)}}}),logoutBtn.addEventListener("click",()=>{token=null,userId=null,localStorage.removeItem("token"),localStorage.removeItem("userId"),authDiv.style.display="block",appDiv.style.display="none"}),loadSummaryBtn.addEventListener("click",async()=>{var t=periodSelect.value,t=await(await fetch("http://localhost:3000/api/transactions/summary?period="+t,{headers:{Authorization:token}})).json();let e=0,a=0;t.forEach(t=>{e+=parseFloat(t.total_income),a+=parseFloat(t.total_expense)});var t=e-a,n=e?(a/e*100).toFixed(2):0,o=e?(t/e*100).toFixed(2):0;summaryOutput.innerHTML=`
        <p>Total Income: $${e.toFixed(2)}</p>
        <p>Total Expenses: $${a.toFixed(2)}</p>
        <p>Profit: $${t.toFixed(2)}</p>
        <p>Expense %: ${n}% | Profit %: ${o}%</p>
    `}),downloadPdfBtn.addEventListener("click",async()=>{var t=window.jspdf.jsPDF,e=document.getElementById("spendingChart"),a=document.getElementById("transactions-section");let n=new t;t=e.toDataURL("image/png",1);n.addImage(t,"PNG",15,15,180,100),await html2canvas(a).then(t=>{t=t.toDataURL("image/png");n.addPage(),n.addImage(t,"PNG",15,15,180,0)}),n.save("FinanceSummary.pdf")});